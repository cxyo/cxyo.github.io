# 基金温度表应用

一个用于展示基金温度和星级评分的Web应用，支持自动从GitHub获取最新数据，并通过GitHub Actions自动化更新基金净值数据。

## 功能特性

- 基金温度实时展示，直观反映市场估值水平
- 温度星级评分（1-6星），参考螺丝钉星级，提供清晰的投资建议
- 支持历史温度图表查看，了解温度变化趋势
- 支持基金净值查询，包含4个时间范围选项（5天、10天、15天、20天）
- 支持搜索和筛选，快速找到目标基金
- 自动从GitHub获取最新数据，确保数据及时性
- 基于文件名的数据加载机制，智能识别本地CSV文件并加载最新的两个文件
- 智能数据缓存机制，提高数据加载速度
- 请求重试机制，提高请求成功率
- 根据请求天数动态调整日期范围，确保数据完整性
- GitHub Actions自动化数据更新，避免API频繁调用导致被封号
- 本地JSON数据优先机制，提高数据获取可靠性
- 详细的日志记录，便于调试和问题定位
- 修复了缓存检查逻辑，确保只有有效数据才会被使用
- 修复了Eastmoney API返回错误-999的问题，添加了本地JSON数据 fallback
- 确保20天历史数据正确显示
- 修复了GitHub Actions工作流中的git commit错误
- 支持本地运行和测试
- 基金净值数据爬虫脚本，便于手动更新数据
- 上传文件时自动从文件名提取日期，更新为对应日期的数据
- 精美的UI设计，所有板块都有黑色边框
- 数据色块显示，温度、涨跌幅、关注度用不同颜色区分
- 类别底色区分，大盘、策略、主题、债券为浅灰色，小盘、行业、海外为浅蓝色
- 精选数据行用金色边框和浅蓝色底色标记
- 日期行用黑色线分成3份，显示数据日期、温度星级、版权信息
- 提示信息区域添加边框，包括点击提示、配置按钮、文件选择等

## 项目结构

```
.
├── index.html          # 主页面
├── css/
│   └── style.css      # 样式文件
├── js/
│   └── app.js         # 主脚本文件
├── data/              # 基金净值数据目录
│   └── fund-nav-data.json  # 基金净值数据文件
├── crawl-fund-nav.js  # 基金净值数据爬虫脚本
├── code.json          # 指数配置文件
├── README.md          # 项目说明文档
├── YYYY-MM-DD.csv     # 每日数据文件
└── .github/
    └── workflows/
        └── update-fund-data.yml  # GitHub Actions工作流文件
```

## 如何上传到GitHub

### 步骤1：创建GitHub仓库

1. 登录GitHub账号
2. 点击右上角的「+」按钮，选择「New repository」
3. 填写仓库名称（建议使用英文名称，如 `fund-temperature`）
4. 选择「Public」或「Private」（建议选择Public，便于GitHub Pages部署）
5. 点击「Create repository」

### 步骤2：上传项目文件

#### 方法1：使用Git命令行（推荐）

1. 安装Git（如果尚未安装）
2. 在本地项目文件夹中打开命令行
3. 初始化Git仓库：
   ```bash
   git init
   ```
4. 添加远程仓库：
   ```bash
   git remote add origin https://github.com/你的用户名/你的仓库名.git
   ```
5. 添加所有文件：
   ```bash
   git add .
   ```
6. 提交更改：
   ```bash
   git commit -m "Initial commit"
   ```
7. 推送到GitHub：
   ```bash
   git push -u origin main
   ```

#### 方法2：使用GitHub Desktop

1. 下载并安装 [GitHub Desktop](https://desktop.github.com/)
2. 登录GitHub账号
3. 点击「Add an existing repository from your hard drive」
4. 选择本地项目文件夹
5. 点击「Publish repository」
6. 选择要发布的仓库，点击「Publish Repository」

### 步骤3：配置GitHub Pages

1. 进入GitHub仓库页面
2. 点击「Settings」选项卡
3. 在左侧菜单中点击「Pages」
4. 在「Source」部分，选择「main」分支
5. 点击「Save」
6. 稍等片刻，GitHub Pages将部署完成，你将看到访问URL

## 如何配置自动更新

### 步骤1：设置GitHub仓库信息

1. 在浏览器中打开部署好的GitHub Pages页面
2. 打开浏览器开发者工具（按F12）
3. 切换到「Console」选项卡
4. 输入以下命令，将你的GitHub仓库信息保存到浏览器本地存储：
   ```javascript
   localStorage.setItem('githubRepo', '你的用户名/你的仓库名');
   ```
   例如：`localStorage.setItem('githubRepo', 'username/fund-temperature');`
5. 刷新页面，应用将自动从GitHub获取最新数据

### 步骤2：使用GitHub Actions自动更新数据

本项目包含一个GitHub Actions工作流，可以手动触发更新基金净值数据。

#### 触发方式

1. 登录GitHub账号，进入仓库页面
2. 点击「Actions」选项卡
3. 在左侧选择「Update Fund Data」工作流
4. 点击「Run workflow」按钮
5. 在弹出的表单中，输入要获取的天数（默认180天）
6. 点击「Run workflow」按钮开始更新数据

#### 工作流执行过程

1. 工作流会自动爬取所有基金代码的历史净值数据
2. 数据会保存到 `data/fund-nav-data.json` 文件
3. 页面刷新时会直接读取该JSON文件，不再调用API
4. 缓存机制会确保数据读取的效率
5. 工作流修复：添加了 `rm -f fetch-fund-data.js` 命令来删除临时脚本文件，避免git commit时出现未跟踪文件错误

#### 工作流优势

- 避免频繁调用API导致被封号
- 自动化数据更新，减少人工操作
- 支持自定义更新天数
- 自动处理临时文件，确保git commit成功
- 清晰的日志输出，便于监控执行情况

### 步骤3：手动上传数据

1. 每天准备好最新的CSV数据文件，命名格式为 `YYYY-MM-DD.csv`（例如：`2025-12-25.csv`）
2. 将CSV文件上传到GitHub仓库根目录
3. GitHub Pages会自动更新
4. 刷新应用页面，即可看到最新数据

## 数据格式要求

### CSV文件格式

CSV文件应包含以下列：
- 指数代码
- 指数名称
- 今日涨跌幅（或涨跌幅）
- 今年涨跌幅（或今年涨跌幅）
- PE-TTM(当前值)
- PE-TTM(分位点%)
- PB(当前值)
- PB(分位点%)
- 关注度

### 数据文件说明

- 每天的数据文件以日期命名，如2026-01-06.csv
- 应用会自动扫描本地目录下的所有CSV文件
- 按文件名日期降序排序，自动加载最新的两个文件
- 最新文件的数据作为上一日涨跌数据
- 次新文件的数据作为上两日涨跌数据
- 历史文件用于生成指数的历史温度变化图表
- 涨跌幅数据通过比较不同日期的文件自动计算

**智能加载机制：**
- 完全基于本地CSV文件的实际名称，不依赖今天明天的日期
- 自动识别最新的两个CSV文件，无需手动指定日期
- 支持文件不连续的情况（如缺少1、2、3、4、10、11等日期）
- 每次增加或减少CSV文件，应用都会自动更新数据，无需修改任何代码
- 上一日涨跌使用最新CSV文件的涨跌幅
- 上两日涨跌使用次新CSV文件的涨跌幅

这种设计使得数据管理更加直观，便于查看历史数据，同时简化了数据更新流程。

## 如何使用

### 部署后使用

1. 打开部署好的GitHub Pages页面
2. 查看基金温度表，绿色表示高温，黄色表示正常，红色表示低温
3. 点击任意指数行，查看历史温度图表
4. 点击场内/场外代码，查看基金净值走势
5. 使用搜索框搜索特定指数
6. 温度星级会自动计算并显示在页面顶部

### 本地运行测试

1. 在项目文件夹中启动本地服务器：
   ```bash
   # 使用http-server（推荐）
   npx http-server -p 8080
   
   # 或使用Python
   python -m http.server 8080
   ```
2. 在浏览器中访问 `http://localhost:8080`
3. 测试各项功能，包括历史净值查询

### 手动更新基金净值数据

1. 确保已安装Node.js
2. 安装依赖：
   ```bash
   npm install node-fetch
   ```
3. 运行爬虫脚本：
   ```bash
   node crawl-fund-nav.js
   ```
4. 脚本会自动爬取所有基金代码的20天历史净值数据，并保存到 `data/fund-nav-data.json` 文件
5. 刷新页面即可看到更新后的数据

## 技术栈

- HTML5
- CSS3
- JavaScript (ES6+)
- ECharts（图表库）
- GitHub Pages（部署）
- jsdelivr（CDN加速）

## 常见问题

### Q: 为什么温度星级显示不正确？
A: 温度星级计算公式参考螺丝钉星级：
1. 首先将平均温度值映射到中证全指数的点数范围（5000-6400）
   ```javascript
   const csi300Index = 5000 + (平均温度 / 100) * 1400;
   ```
2. 然后根据中证全指数计算星级
   ```javascript
   const starRating = 1 + (csi300Index - 5000) / 280;
   ```
   请确保CSV数据中的PE-TTM(分位点%)和PB(分位点%)字段格式正确。

### Q: 如何更新基金映射表？
A: 编辑 `js/app.js` 文件中的 `FUND_CODES_MAP` 对象，添加或修改基金代码映射关系。

### Q: 如何添加新的指数类别？
A: 编辑 `js/app.js` 文件中的 `CATEGORIES` 和 `CATEGORY_MAP` 对象，添加新的类别和映射关系。

### Q: 为什么历史净值获取失败？
A: 可能是因为Eastmoney API返回错误-999，我们已添加本地JSON数据优先机制：
1. 页面会先检查本地 `data/fund-nav-data.json` 文件是否存在
2. 如果存在，优先使用本地JSON数据
3. 如果本地数据不存在或无效，才会调用Eastmoney API
4. 本地JSON数据包含所有基金的20天历史净值，确保数据完整性

### Q: 如何确保20天历史数据正确显示？
A: 我们已修复了数据显示问题：
1. `data/fund-nav-data.json` 文件包含所有主要基金的20天历史净值数据
2. 页面会根据请求天数动态调整日期范围，确保数据完整性
3. 缓存机制确保只有有效数据才会被使用
4. 详细的日志记录便于调试和问题定位

### Q: GitHub Actions工作流为什么会失败？
A: 可能是因为临时脚本文件导致git commit错误，我们已修复：
1. 在工作流中添加了 `rm -f fetch-fund-data.js` 命令来删除临时脚本文件
2. 确保只有 `data/` 目录下的文件被git跟踪
3. 清晰的日志输出便于监控执行情况

## 开发说明

### 本地运行

1. 在项目文件夹中启动本地服务器：
   ```bash
   # 使用http-server（推荐）
   npx http-server -p 8080
   
   # 或使用Python
   python -m http.server 8080
   ```
2. 在浏览器中访问 `http://localhost:8080`
3. 测试各项功能，包括历史净值查询

### 项目结构

```
.
├── index.html          # 主页面
├── css/
│   └── style.css      # 样式文件
├── js/
│   └── app.js         # 主脚本文件
├── data/              # 基金净值数据目录
│   └── fund-nav-data.json  # 基金净值数据文件
├── crawl-fund-nav.js  # 基金净值数据爬虫脚本
├── code.json          # 指数配置文件
├── README.md          # 项目说明文档
├── YYYY-MM-DD.csv     # 每日数据文件
└── .github/
    └── workflows/
        └── update-fund-data.yml  # GitHub Actions工作流文件
```

## 更新日志

### 2026-01-29
- 整合了爬虫脚本到 `crawl_all_data.py`，统一管理所有金融数据爬取
- 修改了GitHub Actions工作流，设置为每天北京时间晚上8点自动运行
- 添加了A股总市值和日换手率数据的爬取（数据来源：集思录）
- 添加了GDP数据的爬取（数据来源：国家统计局）
- 修改了四大魔盒表格，将中证800PE和中证800PB的是否开启列合并成一行
- 修复了表格中的粉色背景色问题，使界面更加整洁
- 调整了页面布局，使中证全指EPV和四大魔盒各占50%宽度
- 为两个部分添加了黑色边框，使其看起来像一个整体
- 添加了防反爬措施，包括随机延迟和异常处理
- 优化了数据保存格式，添加了时间戳和更新时间信息
- 修复了背景颜色问题，确保"是否开启"部分根据中证800 PE和PB值正确显示背景颜色
- 添加了10年期国债收益数据爬取功能（数据来源：investing.com）
- 实现了EPV计算功能，即PE_TTM除以10年期国债收益率
- 实现了基于EPV的投资建议逻辑（黄金坑、白银坑、青铜坑、废坑）
- 计算股市吸引力指标，使用ROE数据除以10年期国债收益率
- 计算巴菲特指数，使用A股总市值除以GDP数据
- 计算7天换手率，使用最近的换手率数据
- 实现了基于特定阈值的魔盒开启/关闭逻辑
- 添加了A股总市值和每日换手率数据爬取
- 添加了GDP数据爬取
- 优化了代码逻辑，减少了硬编码默认值
- 增强了错误处理能力，提高了应用稳定性

### 2026-01-30
- **数据加载性能优化**：实现了缓存优先策略，优先从localStorage加载缓存数据，然后异步更新最新数据，提高页面加载速度
- **并行加载优化**：实现了并行检查CSV文件和加载多个文件，减少串行请求导致的加载延迟
- **金融数据加载优化**：加载合并的`combined_data.json`文件，减少请求次数，提高数据加载效率
- **响应式设计优化**：添加了媒体查询，确保在手机端显示时中证全指EPV和四大魔盒能够正确换行显示
- **页面渲染性能优化**：实现了异步数据加载和增量更新UI，避免页面阻塞，提高用户体验
- **数据文件结构优化**：通过GitHub Actions生成合并的JSON数据文件，前端直接加载这个文件，减少请求次数
- **技术实现细节**：拆分了`loadAllData`函数为多个子函数，提高代码可读性，添加了完善的错误处理机制

### 2026-01-30 (基金温度历史趋势图优化)
- **基金温度数据预处理**：创建了`generate_temperature_json.py`脚本，预处理所有CSV文件，计算每天每个基金的温度数据，生成`fund_temperature.json`文件
- **前端加载优化**：修改了`showTemperatureChart`函数，通过Ajax加载JSON数据，不再需要在客户端处理CSV文件，大幅提高加载速度
- **时间范围选择功能**：实现了默认显示所有数据，以及支持选择5天、10天、15天、20天时间范围的功能
- **基金温度计算修复**：修复了基金温度计算错误，确保温度值显示正确（如48.79°C而不是0.49°C）
- **GitHub Actions配置更新**：修改了工作流文件，添加了生成基金温度数据的步骤，每天自动更新数据
- **数据处理逻辑优化**：添加了BOM字符处理和数据格式解析，确保CSV文件正确处理
- **性能测试验证**：通过本地测试验证，图表加载速度从原来的数秒减少到毫秒级

### 2026-01-27
- 添加了新的主题指数：
  - 中证信创 (931247) - 场内代码：560850，场外代码：-
  - 科创芯片 (000685) - 场内代码：588200，场外代码：017470
  - 国证信创 (CN5075) - 场内代码：562570，场外代码：-
  - 电力指数 (H30199) - 场内代码：159611，场外代码：016186
  - 卫星通信 (980018) - 场内代码：159206，场外代码：-

### 2026-01-16
- 优化了数据加载逻辑，改为智能扫描本地CSV文件并自动识别最新的两个文件
- 完全基于本地文件名，不再依赖今天明天的日期
- 支持文件不连续的情况（如缺少1、2、3、4、10、11等日期）
- 每次增加或减少CSV文件，应用都会自动更新数据，无需修改任何代码
- 上一日涨跌使用最新CSV文件的涨跌幅
- 上两日涨跌使用次新CSV文件的涨跌幅
- 修复了代码中的语法错误和逻辑问题
- 删除了catch块中的旧逻辑，简化了错误处理
- 优化了UI设计，所有板块都添加了黑色边框
- 数据色块显示，温度、涨跌幅、关注度用浅色背景和加粗字体区分
  - 温度：30以下浅红色，30-50浅黄色，50以上浅绿色
  - 涨跌幅：大于0浅红色，小于等于0浅绿色
  - 关注度：大于10000浅红色
- 类别底色区分，大盘、策略、主题、债券为浅灰色，小盘、行业、海外为浅蓝色
- 精选数据行用金色边框和浅蓝色底色标记
- 日期行用黑色线分成3份，显示数据日期、温度星级、版权信息
- 提示信息区域添加边框，包括点击提示、配置按钮、文件选择等
- 清理了CSS中的空规则，修复了代码警告
- 实现了基金温度历史图表功能，点击指数行显示温度历史记录折线图
- 支持选择时间范围（5天、10天、15天、20天），根据CSV文件数量显示对应天数的数据
- 添加了最高和最低温度标记，最高温度用红色显示，最低温度用绿色显示
- 优化了按钮激活状态样式，激活按钮使用白色背景和黑色字体

### 2026-01-15
- 修改了数据加载逻辑，采用动态生成CSV文件名的机制，不再需要手动修改代码
- 优化了温度计算逻辑，确保温度显示正确（如53°C而不是0.53°C）
- 参考螺丝钉星级修改了星级评定公式，支持显示精确的小数星级（如3.85星）
- 调整了星级范围为1-6星，符合螺丝钉星级的评级标准
- 优化了数据上传逻辑，从文件名提取日期，自动更新为对应日期的数据
- 删除了所有时间相关的限制逻辑，包括交易日检查和时间判断条件
- 修复了温度图表和基金净值图表函数未定义的问题
- 动态生成未来2天到过去30天的CSV文件名，自动尝试加载最新的文件
- 历史数据加载也采用动态生成文件名的方式，自动包含最新数据

### 2026-01-12
- 创建了缺失的 `index.html` 主页面文件，修复了网站无法启动的问题
- 确保了项目结构的完整性，使本地运行和测试功能正常工作

## 许可证

MIT License

## 贡献

欢迎提交Issue和Pull Request！

## 联系方式

如有问题或建议，请通过GitHub Issues与我联系。