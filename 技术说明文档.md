# 基金温度表技术说明文档

## 一、项目概述

基金温度表是一个基于纯前端技术构建的指数估值可视化应用，旨在帮助投资者快速了解各类指数的估值状态，并据此做出更加理性的投资决策。该项目无需后端服务器支持，可以直接在浏览器中运行，通过Fetch API异步加载外部数据文件，实现指数温度计算、分类展示、搜索添加等功能。

本应用的核心价值在于将复杂的估值数据转化为直观的"温度"概念，让投资者能够一眼判断当前市场是处于高估还是低估状态。温度越低，代表市场估值越便宜，投资价值越高；温度越高，代表市场估值越贵，投资风险越大。这种设计理念源自于价值投资的核心思想——在市场低估时买入，在市场高估时卖出。

## 二、技术架构与实现原理

### 2.1 前端技术栈

本项目采用纯前端技术实现，不依赖任何后端服务或第三方框架，主要使用以下技术：

**HTML5** 负责页面结构搭建，采用语义化标签构建清晰的页面层次。页面包含头部标题区、日期与星级显示区、星级说明与组合配置区、指数搜索区、基金温度表格区以及配置管理区等多个功能模块。

**CSS3** 负责页面样式设计，采用现代CSS特性实现视觉效果。项目使用了Flexbox和Grid布局实现响应式设计，使页面能够自适应不同尺寸的屏幕。所有板块都添加了黑色边框，数据色块显示，温度、涨跌幅、关注度用浅色背景和加粗字体区分。类别底色区分，大盘、策略、主题、债券为浅灰色，小盘、行业、海外为浅蓝色。精选数据行用金色边框和浅蓝色底色标记。日期行用黑色线分成3份，显示数据日期、温度星级、版权信息。提示信息区域添加边框，包括点击提示、配置按钮、文件选择等。

**JavaScript (ES6+)** 负责所有业务逻辑的实现，包括数据加载、数据处理、温度计算、DOM操作等功能。代码采用模块化设计，将常量配置、数据处理函数、渲染函数等功能分离到不同的代码块中，便于维护和扩展。项目大量使用了箭头函数、解构赋值、Promise等现代JavaScript特性，代码简洁且易读。

**GitHub Actions** 用于自动化数据更新，定期爬取基金净值数据并保存为JSON文件，避免页面访问时频繁调用API导致被封号。

**localStorage** 用于缓存基金净值数据和温度数据，提高页面加载速度，减少API请求次数。智能数据缓存机制确保只有每天晚上8点才会重新爬取数据，其他时间使用缓存。

### 2.2 数据加载机制

数据加载采用智能扫描本地CSV文件的机制，自动识别并加载最新的两个CSV文件，完全基于本地文件名，不再依赖今天明天的日期。具体加载流程如下：

1. **扫描本地CSV文件**：尝试加载过去60天的CSV文件，找到所有存在的文件
2. **按日期降序排序**：将找到的CSV文件按日期降序排序（最新的在前）
3. **加载最新文件**：最大的文件名就是最新的文件（上一日涨跌数据）
4. **加载次新文件**：第二大的文件名就是上两日涨跌数据
5. **合并数据**：将次新文件的上两日涨跌幅合并到最新文件的数据中
6. **本地文件加载失败时**：尝试从localStorage加载缓存数据

**核心特点：**
- 完全基于本地CSV文件的实际名称，不依赖今天明天的日期
- 自动识别最新的两个CSV文件，无需手动指定日期
- 支持文件不连续的情况（如缺少1、2、3、4、10、11等日期）
- 每次增加或减少CSV文件，应用都会自动更新数据，无需修改任何代码
- 上一日涨跌使用最新CSV文件的涨跌幅
- 上两日涨跌使用次新CSV文件的涨跌幅

这种设计确保了应用始终加载最新的数据文件，当添加新的CSV文件（如2026-01-16.csv）时，应用会自动识别并加载它，而不需要修改代码。同时数据日期也会正确显示为实际使用的数据日期。

### 2.3 数据存储方案

本项目使用两种数据存储方案来满足不同的需求：

**localStorage** 用于存储用户的临时配置，如自定义添加的指数代码、用户导入的配置等。这些数据存储在浏览器本地，即使刷新页面也不会丢失，但不会同步到其他设备。localStorage的存储容量通常为5MB左右，对于本应用的配置数据来说完全足够。

**Blob API** 用于配置导出功能。当用户点击"导出配置"按钮时，系统会将当前配置对象转换为JSON字符串，创建一个Blob对象，然后通过动态创建的a标签触发浏览器下载。这种方式不需要服务器支持，完全在客户端完成文件生成和下载。

## 三、核心配置与数据结构

### 3.1 类别配置（CATEGORIES）

类别配置定义了指数的分类体系、权重分配和显示样式，是整个应用的核心配置之一。配置结构如下：

```javascript
const CATEGORIES = {
    'B': { name: '大盘', weight: 20, max_funds: 1, color: '#1a237e' },
    'C': { name: '小盘', weight: 20, max_funds: 1, color: '#4a148c' },
    'D': { name: '策略', weight: 10, max_funds: 2, color: '#1a237e' },
    'E': { name: '行业', weight: 10, max_funds: 2, color: '#4a148c' },
    'F': { name: '主题', weight: 10, max_funds: 2, color: '#1a237e' },
    'G': { name: '海外', weight: 10, max_funds: 1, color: '#4a148c' },
    'H': { name: '债券', weight: 20, max_funds: 2, color: '#1a237e' }
};
```

**配置字段说明：**

| 字段 | 说明 |
|------|------|
| name | 类别中文名称，用于表格和界面的显示 |
| weight | 投资权重百分比，代表该类别在投资组合中的建议占比 |
| max_funds | 每个类别需要选出的指数数量，用于控制表格显示内容 |
| color | 该类别在表格中的背景颜色，采用深蓝色系区分不同类别 |

**七类指数的具体说明：**

大盘指数（B类）主要包括上证50、沪深300等反映大盘蓝筹股走势的指数，是A股市场最具代表性的核心资产标的。

小盘指数（C类）主要包括中证1000、国证2000等反映小盘股走势的指数，通常在市场风格转换时表现活跃。

策略指数（D类）采用特定投资策略的指数，如红利策略、价值策略等。

行业指数（E类）聚焦于特定行业的指数，如银行、医药、消费等。

主题指数（F类）围绕特定主题的指数，如新能源、科技创新等。

海外指数（G类）投资于海外市场的指数，如恒生指数、标普500等。

债券指数（H类）主要投资于债券市场的指数，是稳健型投资的重要组成部分。

### 3.2 指数类别映射（CATEGORY_MAP）

CATEGORY_MAP是一个庞大的索引映射表，将具体的指数代码与类别进行关联。这个映射表的建立基于指数的具体特征和投资属性：

```javascript
const CATEGORY_MAP = {
    // B大盘
    '399006': 'B', '399550': 'B', '000010': 'B', '399330': 'B',
    '399001': 'B', '000300': 'B', '000016': 'B', '000903': 'B',
    // C小盘
    '399673': 'C', '399008': 'C', '000852': 'C', '000905': 'C', '000688': 'C',
    // D策略
    '399348': 'D', '399701': 'D', '000029': 'D', '399702': 'D',
    // ... 更多映射
};
```

这个映射表的主要作用是在表格渲染时，根据指数代码快速确定其所属类别，从而正确显示类别名称和背景颜色。映射表的键是指数代码，值是对应的类别字母。

### 3.3 指数代码与场内/场外基金映射表（FUND_CODES_MAP）

FUND_CODES_MAP是一个将指数代码与对应的场内基金代码和场外基金代码进行关联的映射表：

```javascript
const FUND_CODES_MAP = {
    '399550': {场内代码: '159965', 场外代码: '217027'},
    '399006': {场内代码: '159952', 场外代码: '001593'},
    '000010': {场内代码: '510180', 场外代码: '519180'},
    // ... 更多映射
};
```

这个映射表的主要作用是在表格中显示与指数对应的场内和场外基金代码，用户可以点击这些代码查看对应的基金净值走势图。映射表的键是指数代码，值是一个包含场内代码和场外代码的对象。当某个指数没有对应的场内或场外基金时，对应的值为'-'。

### 3.3 配置文件结构（code.json）

code.json文件存储了每个类别下需要展示的指数代码列表，是数据筛选的主要依据：

```json
{
  "B": ["399006", "399550", "000010", "399330", "399001", "000300", "000016", "000903"],
  "C": ["399673", "399008", "000852", "000905", "000688"],
  "D": ["399348", "399701", "000029", "399702", "399324", "000919", ...],
  "E": ["399807", "399396", "399995", "000932", "399987", ...],
  "F": ["930653", "399997", "399814", "399976", "399971", "931247", "000685", "CN5075", "H30199", "980018", ...],
  "G": ["HSCGSI", "HSTECH", "HSI", "HSCEI", "HSCAIT", "HSMSI", ".INX"]
}
```

文件采用JSON格式存储，键为类别字母，值为该类别下的指数代码数组。用户可以通过导入不同的配置文件来切换显示不同的指数组合。

## 四、核心计算公式与原理

### 4.1 基金温度计算原理

基金温度是本应用最核心的指标，它综合反映了指数的估值水平。温度计算的核心理念来自于对历史估值区间的分析——通过比较当前估值与历史估值区间所处的位置，可以判断当前估值是偏高还是偏低。

**分位点的概念**是温度计算的基础。分位点（Percentile）表示当前值在历史数据中的位置。

例如，PE分位点为0.8意味着当前的PE值高于历史上80%的时间，说明当前估值处于历史高位；PE分位点为0.2则意味着当前的PE值仅高于历史上20%的时间，说明当前估值处于历史低位。

### 4.2 温度计算公式

**行业指数（E类）温度计算公式：**

```
温度 = PB分位点 × 100
```

行业指数的温度只考虑PB（市净率）分位点，这是因为不同行业的盈利模式差异较大，PE值的可比性较低，而PB值相对稳定，更适合作为行业估值的主要指标。

**其他指数温度计算公式：**

```
温度 = (PE分位点 + PB分位点) ÷ 2 × 100
```

对于大盘、小盘、策略、主题、海外等指数，温度综合考虑PE（市盈率）和PB两个指标，取两者的平均值再乘以100得到最终温度值。这样可以更全面地反映指数的估值状态，避免单一指标的片面性。

### 4.3 温度星级评定公式

温度星级是整体市场估值水平的综合评定，参考螺丝钉星级的计算方式，基于中证全指的估值数据计算：

**参考螺丝钉星级计算方式：**
- 中证全指数5000一星
- 中证全指数5280二星
- 中证全指数5560三星
- 中证全指数5840四星
- 中证全指数6120五星
- 中证全指数6400六星

**计算公式：**
1. 首先将平均温度值映射到中证全指数的点数范围（5000-6400）
   ```javascript
   const csi300Index = 5000 + (平均温度 / 100) * 1400;
   ```

2. 然后根据中证全指数计算星级
   ```javascript
   const starRating = 1 + (csi300Index - 5000) / 280;
   ```

**星级含义说明：**

| 星级 | 含义 |
|------|------|
| 1星 | 泡沫阶段，市场很贵，风险很大 |
| 2星 | 市场偏贵，分批卖出 |
| 3星 | 市场正常，正常持有 |
| 4星 | 市场便宜，可以投资 |
| 5星 | 市场最便宜，投资价值最高的阶段 |
| 6星 | 历史上还没有出现过 |

### 4.4 数据解析函数

**parseValue函数**：处理Excel格式的CSV值。Excel导出的CSV文件中，数值会被格式化为`="值"`的形式，该函数负责将这种格式转换为普通数值：

```javascript
function parseValue(val) {
    if (!val) return '';
    val = val.trim();
    if (val.startsWith('="') && val.endsWith('"')) {
        val = val.slice(2, -1);
    } else if (val.startsWith('=')) {
        val = val.slice(1).replace(/^"|"$/g, '');
    }
    val = val.replace(/"/g, '');
    return val;
}
```

**parseNumber函数**：将字符串转换为数值，用于处理PE、PB等不需要百分比的数值：

```javascript
function parseNumber(val) {
    if (!val) return 0;
    val = parseValue(val);
    val = val.replace(/%$/, '');
    const num = parseFloat(val);
    return isNaN(num) ? 0 : num;
}
```

**parsePercent函数**：将百分比字符串转换为数值，注意返回值是百分比数值而非小数：

```javascript
function parsePercent(val) {
    if (!val) return 0;
    val = parseValue(val);
    val = val.replace(/%$/, '');
    const num = parseFloat(val);
    return isNaN(num) ? 0 : num * 100;
}
```

## 五、数据文件格式说明

### 5.1 CSV数据文件结构

应用使用日期命名的CSV文件作为主要数据来源，格式为YYYY-MM-DD.csv，采用标准CSV格式存储，但数值采用Excel格式以确保精度：

**CSV字段说明：**

| 字段名 | 说明 | 示例值 |
|--------|------|--------|
| 指数代码 | 指数的唯一标识符 | ="399006" |
| 指数名称 | 指数的中文名称 | 创业板指 |
| 涨跌幅 | 上一交易日涨跌幅 | =-0.0025 |
| 收盘点位 | 指数收盘点位 | ="2800.50" |
| 今年以来涨跌幅 | 年初至今的涨跌幅 | ="0.0856" |
| PE-TTM(当前值) | 市盈率TTM当前值 | ="45.23" |
| PE-TTM(分位点%) | PE历史分位点 | ="0.6523" |
| PB(当前值) | 市净率当前值 | ="5.67" |
| PB(分位点%) | PB历史分位点 | ="0.7234" |
| 关注度 | 投资者关注度指标 | ="15234" |

**数据文件说明：**

- 每天的数据文件以日期命名，如2026-01-06.csv
- 应用会自动加载所有日期命名的CSV文件
- 最新数据由文件名日期最新的文件提供
- 历史文件用于生成指数的历史温度变化图表
- 涨跌幅数据通过比较不同日期的文件自动计算

这种设计使得数据管理更加直观，便于查看历史数据，同时简化了数据更新流程。

### 5.2 CSV解析实现

CSV解析采用手动解析的方式，能够正确处理带引号的字段：

```javascript
function parseCSVFull(csvText) {
    const lines = csvText.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
    
    const colMap = {};
    headers.forEach((h, idx) => {
        const hLower = h.toLowerCase();
        if (h === '指数代码' || hLower === 'code') colMap.code = idx;
        else if (h === '指数名称' || hLower === 'name') colMap.name = idx;
        else if (h === '今日涨跌幅' || hLower === 'change_pct' || h === '涨跌幅') 
            colMap.change_pct = idx;
        // ... 更多字段映射
    });
    
    const data = {};
    
    for (let i = 1; i < lines.length; i++) {
        const values = [];
        let currentVal = '';
        let inQuotes = false;
        
        for (let j = 0; j < lines[i].length; j++) {
            const char = lines[i][j];
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                values.push(currentVal);
                currentVal = '';
            } else {
                currentVal += char;
            }
        }
        values.push(currentVal);
        
        for (let k = 0; k < values.length; k++) {
            values[k] = values[k].replace(/^"|"$/g, '');
        }
        
        const code = parseValue(values[colMap.code]);
        if (!code || code.length < 2) continue;
        
        data[code] = {
            name: parseValue(values[colMap.name]),
            change_pct: parsePercent(values[colMap.change_pct]),
            year_change_pct: parsePercent(values[colMap.year_change_pct]),
            pe: parseNumber(values[colMap.pe]),
            pb: parseNumber(values[colMap.pb]),
            pe_percentile: parseNumber(values[colMap.pe_percentile]),
            pb_percentile: parseNumber(values[colMap.pb_percentile]),
            attention: parseValue(values[colMap.attention])
        };
    }
    
    return data;
}
```

## 六、核心功能模块详解

### 6.1 数据加载与初始化

页面加载时执行以下初始化流程：

```javascript
document.addEventListener('DOMContentLoaded', function() {
    updateDate();           // 更新日期显示
    calculateAndShowStarRating();  // 计算温度星级
    initCache();            // 初始化数据缓存
    loadAllData();          // 加载所有数据
});
```

**updateDate函数**：更新日期显示，支持自定义日期参数。当未提供参数时，显示当前日期；当提供参数时，显示实际使用的数据日期。

**calculateAndShowStarRating函数**：计算并显示整体市场温度星级，优先使用今天的数据，如果今天数据未上传，则使用昨天的数据。函数逻辑如下：
1. 优先尝试加载今天的CSV文件
2. 如果今天数据未找到，尝试加载昨天的数据
3. 从数据中找到中证全指（000985）的估值数据
4. 根据PE和PB分位点计算星级
5. 更新星级显示

**initCache函数**：初始化数据缓存，从localStorage加载之前缓存的基金净值数据，减少API请求次数。

**loadAllData函数**：主数据加载函数，实现了灵活的日期适配机制：
1. 获取今天和昨天的日期
2. 优先尝试加载今天的CSV文件
3. 如果今天数据未找到，自动回退到昨天的数据
4. 加载配置文件和历史数据
5. 合并数据并计算涨跌幅
6. 渲染基金温度表格
7. 更新数据日期显示为实际使用的数据日期

这种设计确保了在当天数据还未上传时，应用会自动显示前一天的数据，同时数据日期也会正确显示为实际使用的数据日期。

### 6.2 基金净值数据获取与显示

基金净值数据获取功能通过两个核心函数实现：`getSinglePageNavData`和`getFundNavData`。

**getSinglePageNavData函数**：获取单页基金历史净值数据，使用JSONP方式请求东方财富基金API。函数逻辑如下：
1. 生成唯一回调函数名
2. 构建完整的API请求URL
3. 创建script标签并添加到页面
4. 定义回调函数处理API返回数据
5. 设置10秒超时，确保请求稳定性

**getFundNavData函数**：获取基金历史净值数据，支持分页获取和数据缓存。函数逻辑如下：
1. 生成缓存键，检查缓存是否有效
2. 如果缓存有效，直接返回缓存数据
3. 如果缓存无效，计算需要的总页数
4. 并行请求所有页面数据
5. 合并所有数据并去重
6. 只返回最近指定天数的数据
7. 将数据存入缓存并保存到localStorage

### 6.3 历史净值图表显示

历史净值图表使用ECharts实现，支持单位净值和累计净值的双曲线显示，以及多种交互功能。

**showFundNavChart函数**：显示基金净值图表，函数逻辑如下：
1. 更新图表状态
2. 显示图表区域
3. 设置图表标题
4. 更新时间范围按钮状态
5. 显示加载状态
6. 加载基金净值数据
7. 准备图表数据，处理不同字段名的兼容性
8. 初始化ECharts实例
9. 设置图表选项，包括折线样式、标记点、提示框等
10. 渲染图表
11. 监听窗口大小变化，调整图表大小

### 6.4 时间范围选择功能

时间范围选择功能允许用户切换不同的图表显示天数，包括5天、10天、15天、20天（默认）、30天、45天、90天和180天。

**changeChartDays函数**：切换图表显示天数，函数逻辑如下：
1. 更新当前天数
2. 更新按钮激活状态
3. 根据当前图表类型重新渲染
4. 如果是净值图表，重新加载净值数据
5. 如果是温度图表，重新加载温度数据

**updateTimeButtons函数**：更新时间范围按钮的激活状态，根据当前天数高亮对应的按钮。

### 6.5 分页数据获取机制

基金净值数据获取功能支持分页获取，解决了每页最多显示20天数据的限制。

**getSinglePageNavData函数**：获取单页基金历史净值数据，使用JSONP方式请求东方财富基金API。函数逻辑如下：
1. 生成唯一回调函数名
2. 构建完整的API请求URL，包含page参数
3. 创建script标签并添加到页面
4. 定义回调函数处理API返回数据
5. 设置10秒超时，确保请求稳定性

**getFundNavData函数**：获取基金历史净值数据，支持分页获取和数据缓存。函数逻辑如下：
1. 生成缓存键，检查缓存是否有效
2. 如果缓存有效，直接返回缓存数据
3. 如果缓存无效，计算需要的总页数（根据请求的天数，每页20天）
4. 并行请求所有页面数据
5. 合并所有数据并去重
6. 只返回最近指定天数的数据
7. 将数据存入缓存并保存到localStorage

### 6.6 GitHub Actions自动化数据更新

本项目使用GitHub Actions实现自动化数据更新，避免频繁调用API导致被封号。

**工作流文件**：`.github/workflows/update-fund-data.yml`

**触发方式**：手动触发

**执行流程**：
1. 爬取所有基金代码的历史净值数据，默认获取180天
2. 数据保存到`data/fund-nav-data.json`文件
3. 页面刷新时直接读取该JSON文件，不再调用API
4. 缓存机制确保数据读取效率

### 6.7 数据加载时间逻辑

应用实现了时间感知的数据加载逻辑：

1. 每天晚上8点前使用昨天的数据
2. 每天晚上8点后使用今天的数据
3. 自动检测数据文件是否存在，不存在则回退到前一天
4. 显示实际使用的数据日期

### 6.8 数据缓存机制

数据缓存机制使用localStorage存储基金净值数据，减少API请求次数：

- 缓存过期时间：每天晚上8点更新一次
- 缓存键：基金代码+天数
- 缓存验证：检查是否到了每天晚上8点的更新时间
- 缓存更新：每天晚上8点自动更新缓存，其他时间使用缓存数据

**缓存相关函数**：
- **initCache**：从localStorage加载缓存数据
- **saveCache**：将缓存数据保存到localStorage
- **isCacheValid**：检查缓存是否有效，对于所有类型的数据，都使用每天晚上8点更新的机制
- **getNextUpdateTime**：计算下一次更新时间，即当天晚上8点，如果已经过了8点，则为第二天晚上8点

### 6.6 场内/场外代码显示与点击事件

在表格中显示场内代码和场外代码，支持点击查看对应基金的净值走势图。

**代码显示逻辑**：
1. 从FUND_CODES_MAP获取对应指数的场内和场外代码
2. 渲染表格时，根据代码是否为'-'决定是否显示下划线和指针样式
3. 为可点击的代码添加点击事件
4. 点击代码时，调用showFundNavChart显示对应基金的净值图表

**点击事件处理**：
```javascript
// 为场内代码添加点击事件
row.querySelectorAll('td')[7].onclick = (e) => {
    e.stopPropagation();
    if (场内代码 && 场内代码 !== '-') {
        showFundNavChart(场内代码, '场内');
    }
};

// 为场外代码添加点击事件
row.querySelectorAll('td')[8].onclick = (e) => {
    e.stopPropagation();
    if (场外代码 && 场外代码 !== '-') {
        showFundNavChart(场外代码, '场外');
    }
};
```

### 6.7 温度图表显示

温度图表显示功能在原有代码基础上进行了优化，支持根据当前天数显示指定范围的历史温度数据。

**showTemperatureChart函数**：显示历史温度图表，函数逻辑如下：
1. 更新图表状态
2. 显示图表区域
3. 设置图表标题
4. 更新时间范围按钮状态
5. 加载历史数据
6. 根据当前天数筛选数据
7. 准备图表数据
8. 初始化ECharts实例
9. 设置图表选项
10. 渲染图表
11. 监听窗口大小变化，调整图表大小

### 6.8 表格渲染逻辑

renderFundTable是核心渲染函数，其主要逻辑如下：

**第一步：数据匹配与温度计算**

遍历code.json中配置的所有指数代码，在fundsData中查找对应的数据，并计算每个指数的温度值。对于行业指数，温度等于PB分位点乘以100；对于其他指数，温度等于PE和PB分位点的平均值乘以100。

**第二步：类别内排序**

每个类别内按温度升序排序，温度最低的排在前面。如果温度相同，则按关注度降序排列，关注度高的优先显示。

**第三步：精选数据标记**

根据每个类别的max_funds设置，标记前几个指数为"精选"（isTopSelection），精选的指数在表格中会有特殊显示效果，包括金色边框和渐变背景。

**第四步：温度颜色映射**

根据温度值确定显示颜色：温度大于等于50时显示绿色，表示市场偏热；温度在30到50之间时显示黄色，表示市场正常；温度低于30时显示红色，表示市场偏冷。

### 6.3 指数搜索与添加

searchIndex函数实现指数搜索功能：

```javascript
function searchIndex() {
    const keyword = document.getElementById('searchKeyword').value.trim();
    const keywordLower = keyword.toLowerCase();
    searchResults = [];
    
    for (const [code, data] of Object.entries(fundsData)) {
        if (code.toLowerCase().includes(keywordLower) || 
            data.name.toLowerCase().includes(keywordLower)) {
            searchResults.push({ code, name: data.name });
        }
    }
}
```

用户输入关键词后，系统会在所有已加载的指数数据中进行模糊匹配，支持代码和名称两种搜索方式。搜索结果会显示在页面中，用户选择一个指数后，还需要选择其所属类别，最后点击添加到基金温度表。

添加的指数会存储在localStorage中，并与code.json的配置合并显示。如果用户希望永久保存配置，可以导出配置并替换code.json文件。

### 6.4 配置管理功能

配置管理包括导出、导入和清除三个功能：

**导出配置**：将当前显示的所有指数配置导出为JSON文件，用户可以下载保存。

**导入配置**：用户可以选择一个预先准备好的JSON配置文件，导入后应用会使用新配置重新渲染表格。导入时会验证配置中的指数代码是否存在于当前数据中，如果不存在会给出警告。

**清除配置**：清除localStorage中存储的所有自定义配置，并将表格清空。

## 七、变量定义与作用域

### 7.1 全局变量

```javascript
let fundsData = null;      // 当前指数数据（data.csv解析结果）
let oldData = null;        // 历史指数数据（old_data.csv解析结果）
let codeConfig = null;     // 指数代码配置（code.json解析结果）
let searchResults = [];    // 搜索结果数组
let selectedIndex = null;  // 当前选中的指数
let selectedCategory = null;  // 当前选中的类别
let customCodes = null;    // 用户自定义的指数配置

// 缓存相关变量
const CACHE_EXPIRE_TIME = 24 * 60 * 60 * 1000; // 缓存过期时间：24小时
let fundNavCache = {}; // 基金净值数据缓存

// 图表状态变量
let currentChartState = {
    type: null,  // 'temperature' 或 'nav'
    code: null,   // 指数代码或基金代码
    name: null,   // 指数名称或基金名称
    fundType: null, // 场内或场外，仅对净值图表有效
    days: 365      // 当前显示天数，默认365天
};
```

这些全局变量贯穿整个应用的运行周期，存储了应用的核心数据状态。fundsData、oldData和codeConfig在数据加载完成后会被填充，searchResults、selectedIndex和selectedCategory在用户交互过程中会被更新。

新增的全局变量包括：
- **缓存相关变量**：用于存储基金净值数据的缓存，减少API请求
- **图表状态变量**：用于跟踪当前显示的图表类型、代码、名称、基金类型和显示天数

### 7.2 常量配置

CATEGORIES和CATEGORY_MAP定义为常量，在整个应用运行期间不会改变。categorySelectionCount定义了每个类别需要显示的指数数量：

```javascript
const categorySelectionCount = {
    'B': 1,  // 大盘选1个
    'C': 1,  // 小盘选1个
    'D': 2,  // 策略选2个
    'E': 2,  // 行业选2个
    'F': 2,  // 主题选2个
    'G': 1,  // 海外选1个
    'H': 2   // 债券选2个
};
```

这个配置决定了表格中每个类别显示的精选指数数量，总计11个精选指数，涵盖七个类别。

## 八、界面设计与交互

### 8.1 页面布局结构

页面采用垂直布局，从上到下依次为：

1. **头部标题区**：显示"基金温度表"主标题，采用渐变色艺术字设计
2. **日期与星级区**：显示当前日期和整体市场温度星级
3. **说明信息区**：包含星级含义说明、投资组合配置、二维码等辅助信息
4. **搜索功能区**：提供指数搜索和添加到表格的功能
5. **数据展示区**：核心的基金温度表格
6. **配置管理区**：提供配置导出、导入、清除功能
7. **数据更新区**：支持上传新的CSV文件更新数据

### 8.2 响应式设计

页面采用响应式设计，通过CSS媒体查询适配不同屏幕尺寸：

```css
@media (max-width: 768px) {
    .header h1 { font-size: 1.8em; }
    .date-row { flex-direction: column; }
    th, td { padding: 10px 5px; font-size: 0.9em; }
    .star-desc-column { flex: 1 1 45%; min-width: 45%; }
}
```

在移动设备上，标题字号缩小、日期行变为垂直布局、表格单元格内边距减小、四栏布局变为两行两列，确保在各种设备上都能良好显示。

### 8.3 视觉反馈设计

应用在交互过程中提供丰富的视觉反馈：

- **加载动画**：数据加载时显示半透明遮罩层和旋转加载动画
- **按钮悬停**：鼠标悬停时按钮上移并显示阴影效果
- **行悬停效果**：表格行悬停时背景变亮并轻微放大
- **精选标记**：精选行有金色边框和渐变背景
- **涨跌幅颜色**：正数显示红色，负数显示绿色，便于快速识别
- **通知提示**：操作完成后在右上角显示短暂的通知消息

## 九、技术亮点与创新点

### 9.1 数据格式兼容性

应用特别处理了Excel格式的CSV数据，能够正确解析`="值"`格式的数值，确保从Excel导出的数据能够正常显示。这种设计使得数据更新变得简单——用户只需从数据源导出CSV文件，替换原文件即可。

### 9.2 离线功能支持

应用不依赖任何外部API或CDN资源，所有代码和资源都包含在本地。这使得应用可以在完全离线的环境下运行，也不用担心第三方服务不可用导致的问题。

### 9.3 用户配置持久化

通过localStorage实现用户配置的持久化存储，用户的添加、导入等操作不会因为页面刷新而丢失。同时提供配置导出功能，用户可以将配置保存到本地或分享给他人。

### 9.4 灵活的配置切换

应用支持通过导入不同的code.json配置文件来切换不同的指数组合，这为不同投资策略的用户提供了灵活的定制能力。用户可以根据自己的投资偏好，选择关注不同的指数。

### 9.5 基金温度历史图表

应用实现了基金温度历史图表功能，用户可以查看任意指数的温度变化趋势。2026-01-30进行了性能优化，大幅提高了图表加载速度。

**功能特点：**
- 点击指数行显示温度历史记录折线图
- 默认显示所有可用数据，支持选择时间范围（5天、10天、15天、20天）
- 显示最高和最低温度标记
- 平滑曲线和渐变填充效果
- 鼠标悬停显示详细信息
- **性能优化**：通过后端预处理和JSON数据加载，图表加载速度从数秒减少到毫秒级

**技术实现：**
- **后端预处理**：使用`generate_temperature_json.py`脚本预处理所有CSV文件，计算每天每个基金的温度数据
- **数据存储**：生成`fund_temperature.json`文件，存储所有基金的历史温度数据
- **前端加载**：通过Ajax加载JSON数据，不再需要在客户端处理CSV文件
- **时间范围筛选**：根据用户选择的时间范围，从JSON数据中筛选对应天数的数据
- **图表渲染**：使用ECharts库绘制折线图，最高温度标记为红色圆点，最低温度标记为绿色圆点

**温度计算规则：**
- 行业指数（E类）：温度 = PB分位点 × 100
- 其他指数：温度 = (PE分位点 + PB分位点) ÷ 2 × 100

**数据更新机制：**
- GitHub Actions每天自动运行，更新基金温度数据
- 本地运行时可手动执行`python generate_temperature_json.py`更新数据
- 支持添加新的CSV文件，脚本会自动处理并更新JSON数据

**性能优化效果：**
- **加载速度**：从原来的数秒减少到毫秒级
- **客户端计算**：大幅减少客户端计算量，提高页面响应速度
- **数据处理**：统一在后端处理数据格式和BOM字符，确保数据正确性
- **用户体验**：图表加载更加流畅，时间范围切换无卡顿

## 十、运行与部署

### 10.1 运行方式

本应用可以直接在浏览器中打开index.html文件运行，无需任何服务器支持。但需要注意的是，由于浏览器的安全策略限制，直接打开本地文件可能无法正确加载CSV和JSON数据文件。建议使用本地服务器运行，可以使用以下任意方式：

使用VS Code的Live Server插件，在index.html文件上右键选择"Open with Live Server"。

使用Python启动简单服务器，在jjwd目录下执行`python -m http.server 8000`，然后访问http://localhost:8000。

使用Node.js的http-server包，执行`npx http-server`启动服务器。

### 10.2 数据更新

更新数据只需添加新的日期命名CSV文件（如2026-01-07.csv）到项目根目录，然后刷新页面即可。应用会自动识别最新的日期文件并加载数据。

**数据上传规则：**
1. 数据文件必须以日期命名，格式为YYYY-MM-DD.csv
2. 应用会按文件名顺序加载最新数据，不再有时间限制
3. 支持上传任意日期的数据文件，包括非交易日（周六、周日）
4. 上传的数据会自动用于生成历史温度图表
5. 上传文件时，系统会从文件名提取日期，自动更新为对应日期的数据

如果需要修改显示的指数列表，编辑code.json文件或使用导入配置功能。

## 十一、导入的包和依赖

本项目是一个纯前端项目，主要使用原生JavaScript实现，但为了实现历史温度图表功能，引入了ECharts库作为数据可视化工具。

**项目依赖：**

| 依赖名称 | 用途 | 来源 |
|----------|------|------|
| ECharts | 数据可视化，用于绘制历史温度曲线图 | CDN（https://assets.pyecharts.org/assets/v5/echarts.min.js） |
| Papa Parse | CSV解析库，用于处理CSV数据 | 内置（代码中包含手动实现的CSV解析逻辑） |
| Font Awesome | 图标库，用于提供界面图标 | 内置（通过CSS实现的图标效果） |

**项目引用的资源：**

- **CSS样式文件**：`css/style.css`，包含所有页面样式
- **JavaScript脚本**：`js/app.js`，包含所有业务逻辑
- **图片资源**：`images/qrcode.png`，公众号二维码图片
- **数据文件**：`code.json`、`YYYY-MM-DD.csv`（日期命名的CSV文件），包含配置和指数数据

ECharts库通过CDN链接引入，其他资源都通过相对路径在index.html中引用。

## 十二、最近更新与优化

### 12.1 新增功能

- **10年期国债收益数据爬取**：从investing.com爬取中国10年期国债收益率数据，为EPV计算提供基础数据
- **EPV计算功能**：实现了EPV（Equity Premium Value）计算，即PE_TTM除以10年期国债收益率，帮助投资者判断股票市场相对于债券市场的吸引力
- **基于EPV的投资建议**：根据EPV值实现了四级投资建议逻辑（黄金坑、白银坑、青铜坑、废坑），为投资者提供直观的投资参考
- **股市吸引力指标**：使用ROE数据除以10年期国债收益率，计算股市相对于债券的吸引力
- **巴菲特指数**：使用A股总市值除以GDP数据，计算巴菲特指数，衡量股市整体估值水平
- **7天换手率**：计算最近7天的换手率之和，反映市场活跃度
- **魔盒开启/关闭逻辑**：基于特定阈值实现了魔盒的开启/关闭判断，当满足条件时显示不同状态和背景颜色
- **A股总市值和每日换手率数据爬取**：从集思录爬取A股总市值和每日换手率数据
- **GDP数据爬取**：从国家统计局爬取GDP数据，为巴菲特指数计算提供基础数据

### 12.2 界面优化

- **修复背景颜色问题**：确保"是否开启"部分根据中证800 PE和PB值正确显示背景颜色，满足条件时显示浅粉色，不满足时显示浅绿色
- **页面布局调整**：调整了页面布局，使中证全指EPV和四大魔盒各占50%宽度，中间用竖线隔开
- **添加黑色边框**：为中证全指EPV和四大魔盒部分添加了黑色边框，使其看起来像一个整体
- **移除粉色背景**：移除了表格中的粉色背景色，使界面更加整洁
- **合并表格单元格**：修改了四大魔盒表格，将中证800PE和中证800PB的是否开启列合并成一行
- **响应式设计优化**：添加了媒体查询，确保在手机端显示时中证全指EPV和四大魔盒能够正确换行显示，保证显示数据完整，不变形

### 12.3 技术优化

- **整合爬虫脚本**：将所有数据爬取功能整合到`crawl_all_data.py`文件中，统一管理所有金融数据爬取
- **优化GitHub Actions工作流**：修改了GitHub Actions工作流，设置为每天北京时间晚上8点自动运行，确保数据及时更新
- **添加防反爬措施**：在爬虫脚本中添加了随机延迟和异常处理，提高爬取成功率
- **优化数据保存格式**：优化了数据保存格式，添加了时间戳和更新时间信息，便于数据管理和调试
- **减少硬编码默认值**：优化了代码逻辑，减少了硬编码默认值，提高了代码的可维护性
- **增强错误处理**：增强了错误处理能力，提高了应用的稳定性和可靠性

### 12.4 性能优化

- **数据加载性能优化**：实现了缓存优先策略，优先从localStorage加载缓存数据，然后异步更新最新数据，提高页面加载速度
- **并行加载优化**：实现了并行检查CSV文件和加载多个文件，减少串行请求导致的加载延迟
- **金融数据加载优化**：加载合并的`combined_data.json`文件，减少请求次数，提高数据加载效率
- **页面渲染性能优化**：实现了异步数据加载和增量更新UI，避免页面阻塞，提高用户体验
- **数据文件结构优化**：通过GitHub Actions生成合并的JSON数据文件，前端直接加载这个文件，减少请求次数
- **技术实现细节**：拆分了`loadAllData`函数为多个子函数，提高代码可读性，添加了完善的错误处理机制

## 十三、总结

基金温度表应用是一个功能完善、设计精良的前端数据可视化项目。它运用现代Web技术实现了复杂的估值计算和数据展示功能，为投资者提供了一个直观了解市场估值状态的工具。项目的技术特点包括纯前端实现、无需依赖、响应式设计、数据格式兼容、用户配置持久化等，充分体现了前端技术的灵活性和实用性。

通过本应用，用户可以更好地理解指数估值概念，做出更加理性的投资决策。最近的更新和优化进一步增强了应用的功能和可靠性，添加了EPV计算、股市吸引力指标、巴菲特指数等高级分析功能，为投资者提供了更加全面的市场分析工具。应用的界面设计也更加美观和直观，数据展示更加清晰，用户体验得到了显著提升。
